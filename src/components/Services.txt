import React, { useState } from 'react';
import { motion } from 'framer-motion';
import { Code, Smartphone, Cloud, DatabaseBackup, Shield, BarChart3, Plane, Computer, Activity, Hammer, GitGraph, Plus, Minus, ShoppingCart, Edit2, Trash2 } from 'lucide-react';
import { Button } from './ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from './ui/dialog';
import { Badge } from './ui/badge';
import { Separator } from './ui/separator';
import { Input } from './ui/input';
import { Label } from './ui/label';
import { Textarea } from './ui/textarea';
import { useToast } from '../hooks/use-toast';
import { renderQuoteEmail, validateEmailData, generateEmailMetadata } from '../lib/email';
import type { QuoteEmailData, EmailServiceItem, EmailCustomerInfo } from '../lib/email';

interface ServiceComponent {
  id: string;
  name: string;
  description: string;
  category?: string;
}

interface CartItem extends ServiceComponent {
  quantity: number;
  serviceType: string;
}

interface QuoteSubmissionState {
  isSubmitting: boolean;
  error: string | null;
}

const Services = () => {
  const [selectedService, setSelectedService] = useState<any>(null);
  const [cart, setCart] = useState<CartItem[]>([]);
  const [showQuoteForm, setShowQuoteForm] = useState(false);
  const [editingItem, setEditingItem] = useState<string | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [customerInfo, setCustomerInfo] = useState({
    name: '',
    email: '',
    phone: '',
    message: ''
  });
  const [submissionState, setSubmissionState] = useState<QuoteSubmissionState>({
    isSubmitting: false,
    error: null,
  });
  const { toast } = useToast();

  const services = [
    {
      icon: Hammer,
      title: 'Device Repair',
      description: 'We provide expert micro soldering for logic boards, FPC connectors, backlight circuits, and SMD components. We also repair and upgrade laptops, phones, tablets, and game consoles (PlayStation, Xbox, Nintendo).',
      color: 'from-fuchsia-500 to-fuchsia-600',
      components: [
        { id: 'micro-soldering', name: 'Micro Soldering', description: 'Logic board and FPC connector repair' },
        { id: 'backlight-repair', name: 'Backlight Circuit Repair', description: 'Screen backlight troubleshooting' },
        { id: 'laptop-repair', name: 'Laptop Repair', description: 'Complete laptop diagnostics and repair' },
        { id: 'phone-repair', name: 'Phone Repair', description: 'Screen, battery, and component replacement' },
        { id: 'console-repair', name: 'Game Console Repair', description: 'PlayStation, Xbox, Nintendo repairs' },
        { id: 'tablet-repair', name: 'Tablet Repair', description: 'Screen and component replacement' }
      ]
    },
    {
      icon: Code,
      title: 'Custom Software Development',
      description: 'Tailored software solutions designed to streamline your operations and enhance productivity.',
      color: 'from-blue-500 to-blue-600',
      components: [
        { id: 'web-app', name: 'Web Application', description: 'Custom web application development' },
        { id: 'desktop-app', name: 'Desktop Application', description: 'Cross-platform desktop software' },
        { id: 'api-development', name: 'API Development', description: 'RESTful API and microservices' },
        { id: 'database-design', name: 'Database Design', description: 'Custom database architecture' },
        { id: 'software-integration', name: 'Software Integration', description: 'Third-party system integration' }
      ]
    },
    {
      icon: Smartphone,
      title: 'Mobile App Development',
      description: 'Innovative mobile applications for iOS and Android that engage your customers and grow your brand.',
      color: 'from-green-500 to-green-600',
      components: [
        { id: 'ios-app', name: 'iOS App Development', description: 'Native iOS application' },
        { id: 'android-app', name: 'Android App Development', description: 'Native Android application' },
        { id: 'cross-platform', name: 'Cross-Platform App', description: 'React Native or Flutter app' },
        { id: 'app-maintenance', name: 'App Maintenance', description: 'Ongoing app support and updates' },
        { id: 'app-store-optimization', name: 'App Store Optimization', description: 'ASO and publishing support' }
      ]
    },
    {
      icon: Cloud,
      title: 'Cloud Solutions',
      description: 'Scalable cloud infrastructure and services to ensure your business is always available and secure.',
      color: 'from-purple-500 to-purple-600',
      components: [
        { id: 'cloud-migration', name: 'Cloud Migration', description: 'Move existing systems to cloud' },
        { id: 'cloud-setup', name: 'Cloud Infrastructure Setup', description: 'AWS, Azure, or GCP setup' },
        { id: 'cloud-monitoring', name: 'Cloud Monitoring', description: '24/7 cloud infrastructure monitoring' },
        { id: 'backup-solutions', name: 'Backup Solutions', description: 'Automated cloud backup systems' },
        { id: 'load-balancing', name: 'Load Balancing', description: 'High availability configuration' }
      ]
    },
    {
      icon: DatabaseBackup,
      title: 'Data Recovery',
      description: 'Retrieve your valuable data from damaged devices',
      color: 'from-orange-500 to-orange-600',
      components: [
        { id: 'hdd-recovery', name: 'Hard Drive Recovery', description: 'Mechanical and logical HDD recovery' },
        { id: 'ssd-recovery', name: 'SSD Recovery', description: 'Solid state drive data recovery' },
        { id: 'phone-data-recovery', name: 'Phone Data Recovery', description: 'Mobile device data extraction' },
        { id: 'raid-recovery', name: 'RAID Recovery', description: 'RAID array reconstruction' },
        { id: 'emergency-recovery', name: 'Emergency Recovery', description: '24-hour rush data recovery' }
      ]
    },
    {
      icon: Shield,
      title: 'Cybersecurity',
      description: 'Comprehensive security solutions to protect your digital assets and ensure compliance.',
      color: 'from-red-500 to-red-600',
      components: [
        { id: 'security-audit', name: 'Security Audit', description: 'Comprehensive security assessment' },
        { id: 'penetration-testing', name: 'Penetration Testing', description: 'Ethical hacking and vulnerability testing' },
        { id: 'firewall-setup', name: 'Firewall Configuration', description: 'Network firewall implementation' },
        { id: 'security-training', name: 'Security Training', description: 'Employee security awareness training' },
        { id: 'incident-response', name: 'Incident Response', description: 'Security incident handling plan' }
      ]
    },
    {
      icon: BarChart3,
      title: 'Data Analytics',
      description: 'Transform your data into actionable insights with our advanced analytics and visualization tools.',
      color: 'from-indigo-500 to-indigo-600',
      components: [
        { id: 'dashboard-development', name: 'Dashboard Development', description: 'Custom analytics dashboards' },
        { id: 'data-visualization', name: 'Data Visualization', description: 'Interactive charts and reports' },
        { id: 'business-intelligence', name: 'Business Intelligence', description: 'BI system implementation' },
        { id: 'data-modeling', name: 'Data Modeling', description: 'Data warehouse design' },
        { id: 'predictive-analytics', name: 'Predictive Analytics', description: 'Machine learning models' }
      ]
    },
    {
      icon: Plane,
      title: 'Drone Repairs',
      description: 'Specialized repair services for drones of all makes and models. From motor replacements to flight controller issues.',
      color: 'from-purple-500 to-purple-600',
      components: [
        { id: 'motor-replacement', name: 'Motor Replacement', description: 'Drone motor repair and replacement' },
        { id: 'flight-controller', name: 'Flight Controller Repair', description: 'FC diagnostics and repair' },
        { id: 'gimbal-repair', name: 'Gimbal Repair', description: 'Camera gimbal stabilization repair' },
        { id: 'battery-service', name: 'Battery Service', description: 'Battery testing and replacement' },
        { id: 'firmware-update', name: 'Firmware Update', description: 'Drone firmware upgrade service' }
      ]
    },
    {
      icon: Activity,
      title: 'Digital Marketing',
      description: 'Data-driven digital marketing strategies including SEO, PPC, social media marketing, and content creation to increase your online visibility and generate quality leads.',
      color: 'from-emerald-500 to-emerald-600',
      components: [
        { id: 'seo-optimization', name: 'SEO Optimization', description: 'Search engine optimization campaign' },
        { id: 'ppc-management', name: 'PPC Management', description: 'Google Ads and social media ads' },
        { id: 'social-media', name: 'Social Media Marketing', description: 'Social media strategy and management' },
        { id: 'content-creation', name: 'Content Creation', description: 'Blog posts, articles, and copywriting' },
        { id: 'email-marketing', name: 'Email Marketing', description: 'Email campaign design and automation' }
      ]
    },
    {
      icon: Computer,
      title: 'IT Support',
      description: '24/7 availability IT support. Our helpdesk solutions include remote support, on-site visits, and proactive monitoring.',
      color: 'from-zinc-500 to-zinc-600',
      components: [
        { id: 'helpdesk-support', name: 'Helpdesk Support', description: '24/7 remote IT support' },
        { id: 'on-site-support', name: 'On-Site Support', description: 'Technical support at your location' },
        { id: 'network-setup', name: 'Network Setup', description: 'Business network configuration' },
        { id: 'system-monitoring', name: 'System Monitoring', description: 'Proactive system health monitoring' },
        { id: 'software-installation', name: 'Software Installation', description: 'Software deployment and configuration' }
      ]
    },
    {
      icon: GitGraph,
      title: 'Graphics Design',
      description: 'Boost your brand with professional graphic design services—custom logos, eye-catching graphics, sleek business cards, and stunning brochures designed to make your business stand out!',
      color: 'from-cyan-500 to-cyan-600',
      components: [
        { id: 'logo-design', name: 'Logo Design', description: 'Custom logo and brand identity' },
        { id: 'business-cards', name: 'Business Cards', description: 'Professional business card design' },
        { id: 'brochure-design', name: 'Brochure Design', description: 'Marketing brochure and flyer design' },
        { id: 'web-graphics', name: 'Web Graphics', description: 'Website graphics and banners' },
        { id: 'brand-package', name: 'Complete Brand Package', description: 'Full brand identity package' }
      ]
    }
  ];

  const addToCart = (component: ServiceComponent, serviceTitle: string) => {
    const existingItem = cart.find(item => item.id === component.id);
    if (existingItem) {
      setCart(cart.map(item => 
        item.id === component.id 
          ? { ...item, quantity: item.quantity + 1 }
          : item
      ));
    } else {
      setCart([...cart, { ...component, quantity: 1, serviceType: serviceTitle }]);
    }
    toast({
      title: "Added to cart",
      description: `${component.name} has been added to your cart.`,
    });
  };

  const removeFromCart = (componentId: string) => {
    setCart(cart.filter(item => item.id !== componentId));
    toast({
      title: "Removed from cart",
      description: "Item has been removed from your cart.",
    });
  };

  const updateQuantity = (componentId: string, newQuantity: number) => {
    if (newQuantity === 0) {
      removeFromCart(componentId);
    } else {
      setCart(cart.map(item => 
        item.id === componentId 
          ? { ...item, quantity: newQuantity }
          : item
      ));
    }
  };

  const getTotalItems = () => {
    return cart.reduce((total, item) => total + item.quantity, 0);
  };

  const sendQuoteEmail = async (quotationData: QuoteEmailData) => {
    try {
      // Generate email HTML locally for demonstration
      const emailHtml = await renderQuoteEmail(quotationData);
      const metadata = generateEmailMetadata(quotationData);
      
      console.log('Email generated:', { metadata, htmlLength: emailHtml.length });
      
      // Send to PHP backend API
      const response = await fetch('/api/send-quote.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          to: metadata.to,
          customer: quotationData.customer,
          items: quotationData.items,
          totalItems: quotationData.totalItems,
        }),
      });

      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || `HTTP error! status: ${response.status}`);
      }
      
      return {
        success: result.success,
        message: result.message || 'Quote request sent successfully',
        quoteId: result.quoteId,
      };
      
    } catch (error) {
      console.error('Error sending email:', error);
      throw error;
    }
  };

  const handleQuoteSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSubmissionState({ isSubmitting: true, error: null });
    
    try {
      // Validate form data
      if (!customerInfo.name || !customerInfo.email) {
        toast({
          title: "Validation Error",
          description: "Please fill in all required fields.",
          variant: "destructive"
        });
        setSubmissionState({ isSubmitting: false, error: "Please fill in all required fields." });
        return;
      }

      if (cart.length === 0) {
        toast({
          title: "Empty Cart",
          description: "Please add some services to your cart before requesting a quote.",
          variant: "destructive"
        });
        setSubmissionState({ isSubmitting: false, error: "Empty cart" });
        return;
      }

      const quotationData = {
        customer: customerInfo,
        items: cart,
        date: new Date().toISOString()
      };

      // Validate email data
      const validation = validateEmailData(quotationData);
      if (!validation.isValid) {
        toast({
          title: "Validation Error",
          description: validation.errors.join(', '),
          variant: "destructive"
        });
        setSubmissionState({ isSubmitting: false, error: validation.errors.join(', ') });
        return;
      }

      toast({
        title: "Sending quote request...",
        description: "Please wait while we process your request.",
      });

      const result = await sendQuoteEmail(quotationData);
      
      toast({
        title: "Quote Requested!",
        description: `${result.message || "We'll send your detailed quotation within 24 hours."} Quote ID: ${result.quoteId || 'Generated'}`,
      });

      // Reset form and cart
      setCustomerInfo({ name: '', email: '', phone: '', message: '' });
      setCart([]);
      setShowQuoteForm(false);
      setSubmissionState({ isSubmitting: false, error: null });
      
    } catch (error) {
      console.error('Quote submission error:', error);
      const errorMessage = error instanceof Error ? error.message : "Failed to send quote request. Please try again.";
      
      toast({
        title: "Error",
        description: errorMessage,
        variant: "destructive"
      });
      
      setSubmissionState({ isSubmitting: false, error: errorMessage });
    } finally {
      if (submissionState.isSubmitting) {
        setSubmissionState({ isSubmitting: false, error: null });
      }
    }
  };

  return (
    <section id="services" className="py-20 bg-muted/50">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <motion.div 
          className="text-center mb-16"
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
        >
          <h2 className="text-3xl md:text-4xl font-bold mb-4">
            Our <span className="text-primary">Services</span>
          </h2>
          <p className="max-w-2xl mx-auto text-muted-foreground">
            We offer comprehensive technology solutions tailored to your business needs.
          </p>
          
          {cart.length > 0 && (
            <div className="mt-8 flex justify-center">
              <div className="bg-card rounded-lg p-4 shadow-md border">
                <div className="flex items-center gap-4">
                  <div className="flex items-center gap-2">
                    <ShoppingCart className="h-5 w-5" />
                    <span className="font-medium">{cart.length} items in cart</span>
                  </div>
                  <Badge variant="secondary">
                    {getTotalItems()} total items
                  </Badge>
                  <Button onClick={() => setShowQuoteForm(true)} size="sm">
                    Get Quote
                  </Button>
                </div>
              </div>
            </div>
          )}
        </motion.div>
        
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          {services.map((service, index) => (
            <motion.div
              key={service.title}
              className="bg-card rounded-xl p-8 shadow-md hover:shadow-xl transition-all duration-300 group cursor-pointer"
              initial={{ opacity: 0, y: 30 }}
              whileInView={{ opacity: 1, y: 0 }}
              whileHover={{ y: -10 }}
              viewport={{ once: true }}
              transition={{ delay: index * 0.1 }}
              onClick={() => setSelectedService(service)}
            >
              <motion.div 
                className={`w-16 h-16 bg-gradient-to-r ${service.color} rounded-lg flex items-center justify-center text-white mb-6 group-hover:scale-110 transition-transform duration-300`}
                whileHover={{ rotate: 360 }}
                transition={{ duration: 0.6 }}
              >
                <service.icon size={32} />
              </motion.div>
              <h3 className="text-xl font-bold mb-3 group-hover:text-primary transition-colors duration-300">
                {service.title}
              </h3>
              <p className="text-muted-foreground">{service.description}</p>
              <div className="mt-4">
                <Button variant="outline" size="sm" className="w-full">
                  View Components
                </Button>
              </div>
            </motion.div>
          ))}
        </div>
      </div>

      {/* Service Details Modal */}
      <Dialog open={!!selectedService} onOpenChange={() => setSelectedService(null)}>
        <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-3 text-2xl">
              {selectedService?.icon && <selectedService.icon className="h-8 w-8" />}
              {selectedService?.title}
            </DialogTitle>
          </DialogHeader>
          
          <div className="space-y-6">
            <p className="text-muted-foreground">{selectedService?.description}</p>
            
            <Separator />
            
            <div>
              <h3 className="text-lg font-semibold mb-4">Available Components & Services</h3>
              <div className="grid gap-4">
                {selectedService?.components?.map((component: ServiceComponent) => {
                  const cartItem = cart.find(item => item.id === component.id);
                  return (
                    <div key={component.id} className="border rounded-lg p-4 space-y-3">
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <h4 className="font-medium">{component.name}</h4>
                          <p className="text-sm text-muted-foreground">{component.description}</p>
                        </div>
                      </div>
                      
                      <div className="flex items-center justify-between">
                        {cartItem ? (
                          <div className="flex items-center gap-2">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => updateQuantity(component.id, cartItem.quantity - 1)}
                            >
                              <Minus className="h-4 w-4" />
                            </Button>
                            <span className="w-8 text-center font-medium">{cartItem.quantity}</span>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => updateQuantity(component.id, cartItem.quantity + 1)}
                            >
                              <Plus className="h-4 w-4" />
                            </Button>
                          </div>
                        ) : (
                          <Button
                            onClick={() => addToCart(component, selectedService.title)}
                            size="sm"
                          >
                            <Plus className="h-4 w-4 mr-1" />
                            Add to Cart
                          </Button>
                        )}
                        
                        {cartItem && (
                          <Button
                            variant="destructive"
                            size="sm"
                            onClick={() => removeFromCart(component.id)}
                          >
                            Remove
                          </Button>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Quote Form Modal */}
      <Dialog open={showQuoteForm} onOpenChange={setShowQuoteForm}>
        <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Request Quote</DialogTitle>
          </DialogHeader>
          
          <form onSubmit={handleQuoteSubmit} className="space-y-6">
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <h3 className="font-semibold">Selected Services ({cart.length} items)</h3>
                <Badge variant="outline">{getTotalItems()} total quantity</Badge>
              </div>
              
              {cart.map((item) => (
                <div key={item.id} className="border rounded-lg p-4">
                  <div className="flex justify-between items-start mb-3">
                    <div className="flex-1">
                      <div className="font-medium">{item.name}</div>
                      <div className="text-sm text-muted-foreground">{item.serviceType}</div>
                      <div className="text-sm text-muted-foreground mt-1">{item.description}</div>
                    </div>
                    <div className="flex items-center gap-2 ml-4">
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => setEditingItem(editingItem === item.id ? null : item.id)}
                      >
                        <Edit2 className="h-4 w-4" />
                      </Button>
                      <Button
                        type="button"
                        variant="destructive"
                        size="sm"
                        onClick={() => removeFromCart(item.id)}
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                  
                  {editingItem === item.id ? (
                    <div className="flex items-center gap-2 pt-2 border-t">
                      <Label className="text-sm">Quantity:</Label>
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => updateQuantity(item.id, Math.max(1, item.quantity - 1))}
                      >
                        <Minus className="h-4 w-4" />
                      </Button>
                      <span className="w-12 text-center font-medium">{item.quantity}</span>
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => updateQuantity(item.id, item.quantity + 1)}
                      >
                        <Plus className="h-4 w-4" />
                      </Button>
                    </div>
                  ) : (
                    <div className="text-sm text-muted-foreground pt-2 border-t">
                      Quantity: {item.quantity}
                    </div>
                  )}
                </div>
              ))}
              
              {cart.length === 0 && (
                <div className="text-center text-muted-foreground py-8">
                  <ShoppingCart className="h-12 w-12 mx-auto mb-4 opacity-50" />
                  <p>No services selected. Please add services to your cart first.</p>
                </div>
              )}
            </div>
            
            <Separator />
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label htmlFor="name">Full Name *</Label>
                <Input
                  id="name"
                  value={customerInfo.name}
                  onChange={(e) => setCustomerInfo({...customerInfo, name: e.target.value})}
                  required
                />
              </div>
              <div>
                <Label htmlFor="email">Email *</Label>
                <Input
                  id="email"
                  type="email"
                  value={customerInfo.email}
                  onChange={(e) => setCustomerInfo({...customerInfo, email: e.target.value})}
                  required
                />
              </div>
            </div>
            
            <div>
              <Label htmlFor="phone">Phone Number</Label>
              <Input
                id="phone"
                value={customerInfo.phone}
                onChange={(e) => setCustomerInfo({...customerInfo, phone: e.target.value})}
              />
            </div>
            
            <div>
              <Label htmlFor="message">Additional Requirements</Label>
              <Textarea
                id="message"
                placeholder="Please describe any specific requirements or questions..."
                value={customerInfo.message}
                onChange={(e) => setCustomerInfo({...customerInfo, message: e.target.value})}
                rows={4}
              />
            </div>
            
            <div className="flex gap-3">
              <Button type="button" variant="outline" onClick={() => setShowQuoteForm(false)} className="flex-1">
                Cancel
              </Button>
              <Button type="submit" className="flex-1" disabled={cart.length === 0 || submissionState.isSubmitting}>
                {submissionState.isSubmitting ? 'Sending...' : 'Request Quote'}
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>
    </section>
  );
};

export default Services;